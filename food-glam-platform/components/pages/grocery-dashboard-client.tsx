'use client'

import React, { useState, useEffect, useCallback } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import type { BudgetTier } from '@/lib/ai-provider'
import type { GroceryVendor } from '@/lib/grocery/vendors'

interface ShoppingList {
  id: string
  name: string
  created_at: string
  source_type?: string | null
}

interface UserVendorConfig {
  vendor_id: string
  is_default: boolean
  preferred_store?: string | null
  preferred_city?: string | null
}

interface BudgetPrefs {
  default_budget_tier: BudgetTier
  pack_size_optimisation: boolean
  substitutions_enabled: boolean
}

const BUDGET_META: Record<BudgetTier, { label: string; color: string; bg: string; desc: string }> = {
  budget:  { label: 'ğŸ’š Budget',  color: '#1b5e20', bg: '#e8f5e9', desc: 'Lowest price Â· Kaufland â†’ Bringo â†’ Glovo' },
  normal:  { label: 'ğŸ’› Normal',  color: '#5d4037', bg: '#fff8e1', desc: 'Price + convenience Â· Bringo â†’ Carrefour â†’ Freshful' },
  premium: { label: 'ğŸ’œ Premium', color: '#4a148c', bg: '#f3e5f5', desc: 'Best quality Â· Freshful â†’ Carrefour â†’ Bringo' },
}

const BG = '#dde3ee'

function getUserId() {
  if (typeof window === 'undefined') return 'anonymous'
  try { return JSON.parse(localStorage.getItem('mock_user') ?? '{}')?.id ?? 'anonymous' } catch { return 'anonymous' }
}

export default function GroceryDashboardClient() {
  const router = useRouter()
  const searchParams = useSearchParams()
  // Support coming from scan "Order missing" with a pre-selected list
  const fromScan = searchParams.get('from_scan')

  const [lists, setLists] = useState<ShoppingList[]>([])
  const [vendors, setVendors] = useState<GroceryVendor[]>([])
  const [myVendors, setMyVendors] = useState<UserVendorConfig[]>([])
  const [budgetPrefs, setBudgetPrefs] = useState<BudgetPrefs>({ default_budget_tier: 'normal', pack_size_optimisation: true, substitutions_enabled: true })
  const [loading, setLoading] = useState(true)
  const [savingBudget, setSavingBudget] = useState(false)
  const [togglingVendor, setTogglingVendor] = useState<string | null>(null)
  const [showSetup, setShowSetup] = useState(false) // accordion for budget/vendor config

  const userId = getUserId()
  const headers = { 'x-mock-user-id': userId }

  const fetchAll = useCallback(async () => {
    try {
      const [listsRes, vendorsRes, myVRes, budgetRes] = await Promise.all([
        fetch('/api/shopping-lists', { headers }),
        fetch('/api/grocery/vendors'),
        fetch('/api/grocery/vendors/my', { headers }),
        fetch('/api/grocery/budget-prefs', { headers }),
      ])
      if (listsRes.ok) setLists(await listsRes.json())
      if (vendorsRes.ok) setVendors(await vendorsRes.json())
      if (myVRes.ok) {
        const configs: UserVendorConfig[] = await myVRes.json()
        setMyVendors(configs)
        // Auto-open setup if no stores selected yet
        if (configs.length === 0) setShowSetup(true)
      }
      if (budgetRes.ok) setBudgetPrefs(await budgetRes.json())
    } catch { /* ignore */ }
    finally { setLoading(false) }
  }, []) // eslint-disable-line react-hooks/exhaustive-deps

  useEffect(() => { fetchAll() }, [fetchAll])

  const toggleVendor = async (vendorId: string) => {
    setTogglingVendor(vendorId)
    const isActive = myVendors.some(v => v.vendor_id === vendorId)
    try {
      if (isActive) {
        await fetch('/api/grocery/vendors/my', {
          method: 'DELETE',
          headers: { ...headers, 'Content-Type': 'application/json' },
          body: JSON.stringify({ vendor_id: vendorId }),
        })
        setMyVendors(prev => prev.filter(v => v.vendor_id !== vendorId))
      } else {
        const res = await fetch('/api/grocery/vendors/my', {
          method: 'POST',
          headers: { ...headers, 'Content-Type': 'application/json' },
          body: JSON.stringify({ vendor_id: vendorId, is_default: myVendors.length === 0 }),
        })
        if (res.ok) {
          const data: UserVendorConfig = await res.json()
          setMyVendors(prev => [...prev, data])
        }
      }
    } finally {
      setTogglingVendor(null)
    }
  }

  const saveBudget = async (tier: BudgetTier) => {
    if (tier === budgetPrefs.default_budget_tier) return
    setSavingBudget(true)
    try {
      const res = await fetch('/api/grocery/budget-prefs', {
        method: 'PATCH',
        headers: { ...headers, 'Content-Type': 'application/json' },
        body: JSON.stringify({ default_budget_tier: tier }),
      })
      if (res.ok) setBudgetPrefs(await res.json())
    } finally { setSavingBudget(false) }
  }

  if (loading) {
    return (
      <main style={{ background: BG, minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <div style={{ textAlign: 'center', color: '#555' }}>
          <div style={{ width: 32, height: 32, border: '3px solid #ccc', borderTopColor: '#555', borderRadius: '50%', animation: 'spin 0.8s linear infinite', margin: '0 auto 12px' }} />
          Loadingâ€¦
        </div>
        <style>{`@keyframes spin { to { transform: rotate(360deg) } }`}</style>
      </main>
    )
  }

  const activeVendorIds = new Set(myVendors.map(v => v.vendor_id))
  const noStoresSelected = activeVendorIds.size === 0
  const budgetMeta = BUDGET_META[budgetPrefs.default_budget_tier] ?? BUDGET_META.normal
  const activeVendorNames = (vendors ?? []).filter(v => activeVendorIds.has(v.id)).map(v => v.name)

  return (
    <main style={{ background: BG, minHeight: '100vh', color: '#111', paddingBottom: 100 }}>
      <div style={{ maxWidth: 680, margin: '0 auto', padding: '20px 16px' }}>

        {/* Back */}
        <button
          onClick={() => router.back()}
          style={{ display: 'flex', alignItems: 'center', gap: 6, background: 'none', border: 'none', cursor: 'pointer', color: '#555', fontSize: 14, padding: '8px 0', marginBottom: 12, minHeight: 44 }}
        >
          â† Back
        </button>

        <h1 style={{ fontSize: 26, fontWeight: 700, margin: '0 0 2px' }}>ğŸ›’ Grocery Shop</h1>
        <p style={{ color: '#666', fontSize: 14, margin: '0 0 20px' }}>
          Send your shopping list to a store, optimised for your budget.
        </p>

        {fromScan && (
          <div style={{ background: '#e8f0fe', borderRadius: 12, padding: '12px 16px', marginBottom: 16, fontSize: 13, color: '#1a56db', display: 'flex', alignItems: 'center', gap: 8 }}>
            ğŸ“· <span>Came from a scan â€” pick a list below to order missing ingredients.</span>
          </div>
        )}

        {/* â”€â”€ Config accordion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        <button
          onClick={() => setShowSetup(s => !s)}
          style={{
            width: '100%', display: 'flex', alignItems: 'center', justifyContent: 'space-between',
            background: '#fff', borderRadius: showSetup ? '14px 14px 0 0' : 14,
            padding: '14px 18px', border: 'none', cursor: 'pointer',
            boxShadow: '0 1px 4px rgba(0,0,0,0.08)', marginBottom: showSetup ? 0 : 16,
            transition: 'border-radius 0.15s',
          }}
        >
          <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
            <span style={{ fontSize: 18 }}>âš™ï¸</span>
            <div style={{ textAlign: 'left' }}>
              <div style={{ fontWeight: 600, fontSize: 14 }}>Store settings</div>
              <div style={{ fontSize: 12, color: '#888', marginTop: 1 }}>
                {noStoresSelected
                  ? 'âš ï¸ No stores selected â€” tap to choose'
                  : `${budgetMeta.label} Â· ${activeVendorNames.join(', ')}`}
              </div>
            </div>
          </div>
          <span style={{ color: '#888', fontSize: 18, transform: showSetup ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }}>â€º</span>
        </button>

        {showSetup && (
          <div style={{ background: '#fff', borderRadius: '0 0 14px 14px', padding: '0 18px 18px', boxShadow: '0 1px 4px rgba(0,0,0,0.08)', marginBottom: 16 }}>
            <div style={{ borderTop: '1px solid #f0f0f0', paddingTop: 16 }}>

              {/* Budget selector */}
              <div style={{ marginBottom: 16 }}>
                <div style={{ fontSize: 12, fontWeight: 600, color: '#666', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: 8 }}>Budget Mode</div>
                <div style={{ display: 'flex', gap: 7 }}>
                  {(Object.entries(BUDGET_META) as [BudgetTier, typeof BUDGET_META[BudgetTier]][]).map(([tier, meta]) => (
                    <button
                      key={tier}
                      onClick={() => saveBudget(tier)}
                      disabled={savingBudget}
                      style={{
                        flex: 1, padding: '9px 4px', borderRadius: 10, fontWeight: 600, fontSize: 13,
                        border: budgetPrefs.default_budget_tier === tier ? `2px solid ${meta.color}` : '2px solid #e8e8e8',
                        background: budgetPrefs.default_budget_tier === tier ? meta.bg : '#f8f8f8',
                        color: budgetPrefs.default_budget_tier === tier ? meta.color : '#555',
                        cursor: savingBudget ? 'default' : 'pointer',
                        transition: 'all 0.15s',
                        minHeight: 44,
                      }}
                    >
                      {meta.label}
                    </button>
                  ))}
                </div>
                <p style={{ fontSize: 12, color: '#888', margin: '8px 0 0' }}>{budgetMeta.desc}</p>
              </div>

              {/* Store selector */}
              <div>
                <div style={{ fontSize: 12, fontWeight: 600, color: '#666', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: 8 }}>My Stores</div>
                <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                  {(vendors ?? []).map(v => {
                    const active = activeVendorIds.has(v.id)
                    const toggling = togglingVendor === v.id
                    return (
                      <div
                        key={v.id}
                        onClick={() => !toggling && toggleVendor(v.id)}
                        style={{
                          display: 'flex', alignItems: 'center', gap: 12,
                          padding: '11px 13px', borderRadius: 10,
                          border: active ? '2px solid #111' : '2px solid #e8e8e8',
                          background: active ? '#f0f0f0' : '#fafafa',
                          cursor: toggling ? 'default' : 'pointer',
                          opacity: toggling ? 0.6 : 1,
                          transition: 'all 0.15s',
                          minHeight: 52,
                        }}
                      >
                        <span style={{ fontSize: 22 }}>{v.logoEmoji}</span>
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <div style={{ fontWeight: 600, fontSize: 14 }}>{v.name}</div>
                          <div style={{ fontSize: 12, color: '#777', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{v.description}</div>
                        </div>
                        <div style={{
                          width: 24, height: 24, borderRadius: '50%', flexShrink: 0,
                          border: active ? '2px solid #111' : '2px solid #bbb',
                          background: active ? '#111' : 'transparent',
                          display: 'flex', alignItems: 'center', justifyContent: 'center',
                        }}>
                          {active && <span style={{ color: '#fff', fontSize: 13, lineHeight: 1 }}>âœ“</span>}
                        </div>
                      </div>
                    )
                  })}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* â”€â”€ Order history link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        <button
          onClick={() => router.push('/me/grocery/orders')}
          style={{
            width: '100%', display: 'flex', alignItems: 'center', gap: 10,
            background: '#fff', borderRadius: 12, padding: '12px 16px',
            border: 'none', cursor: 'pointer', marginBottom: 16,
            boxShadow: '0 1px 3px rgba(0,0,0,0.06)', minHeight: 44,
          }}
        >
          <span style={{ fontSize: 18 }}>ğŸ“‹</span>
          <span style={{ flex: 1, textAlign: 'left', fontSize: 14, fontWeight: 500, color: '#333' }}>Order History</span>
          <span style={{ color: '#888', fontSize: 14 }}>â†’</span>
        </button>

        {/* â”€â”€ Shopping lists â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        <div style={{ marginBottom: 8, display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
          <h2 style={{ fontSize: 15, fontWeight: 600, margin: 0 }}>Your Lists</h2>
          <button
            onClick={() => router.push('/me/shopping-lists')}
            style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#555', fontSize: 13, padding: '4px 0' }}
          >
            Manage â†’
          </button>
        </div>

        {noStoresSelected && (
          <div style={{ background: '#fff3cd', borderRadius: 12, padding: '12px 16px', marginBottom: 12, fontSize: 13, color: '#856404', display: 'flex', alignItems: 'center', gap: 8 }}>
            <span>âš ï¸</span>
            <span>Select at least one store above before sending a list.</span>
            <button
              onClick={() => setShowSetup(true)}
              style={{ marginLeft: 'auto', background: '#856404', color: '#fff', border: 'none', borderRadius: 7, padding: '5px 10px', fontSize: 12, fontWeight: 600, cursor: 'pointer' }}
            >
              Set up
            </button>
          </div>
        )}

        {lists.length === 0 ? (
          <div style={{ background: '#fff', borderRadius: 14, padding: '28px 20px', textAlign: 'center', boxShadow: '0 1px 4px rgba(0,0,0,0.07)' }}>
            <div style={{ fontSize: 36, marginBottom: 8 }}>ğŸ“‹</div>
            <p style={{ color: '#888', fontSize: 14, marginBottom: 12 }}>No shopping lists yet.</p>
            <button
              onClick={() => router.push('/me/shopping-lists')}
              style={{ background: '#111', color: '#fff', border: 'none', borderRadius: 9, padding: '11px 20px', fontSize: 14, fontWeight: 600, cursor: 'pointer', minHeight: 44 }}
            >
              Create a list
            </button>
          </div>
        ) : (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
            {lists.map(list => (
              <div
                key={list.id}
                style={{ background: '#fff', borderRadius: 12, padding: '14px 16px', boxShadow: '0 1px 3px rgba(0,0,0,0.06)', display: 'flex', alignItems: 'center', gap: 12 }}
              >
                <div style={{ flex: 1, minWidth: 0 }}>
                  <div style={{ fontWeight: 600, fontSize: 14, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{list.name}</div>
                  <div style={{ fontSize: 11, color: '#aaa', marginTop: 2 }}>
                    {new Date(list.created_at).toLocaleDateString()}
                  </div>
                </div>
                <button
                  onClick={() => router.push(`/me/grocery/match/${list.id}`)}
                  disabled={noStoresSelected}
                  style={{
                    background: noStoresSelected ? '#e0e0e0' : '#111',
                    color: noStoresSelected ? '#aaa' : '#fff',
                    border: 'none', borderRadius: 9,
                    padding: '9px 16px', fontSize: 13, fontWeight: 700,
                    cursor: noStoresSelected ? 'not-allowed' : 'pointer',
                    whiteSpace: 'nowrap', minHeight: 40,
                    transition: 'background 0.15s',
                  }}
                  title={noStoresSelected ? 'Select a store first' : undefined}
                >
                  Send â†’
                </button>
              </div>
            ))}
          </div>
        )}
      </div>
    </main>
  )
}
